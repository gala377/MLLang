
let struct = scope:
  let new = do fields methods:
    let typeid = gensym!

    let constr = do vals:
      let passedKeys = map vals fst

      foreach fields do field:
        if none? (seq.find passedKeys (eq? field)):
          panic "Not every field has been passed to type constructor"
      foreach vals do fpair:
        if none? (seq.find fields (eq? (fst fpair))):
          panic "Uknown field passed to type constructor"

      let this = extend vals {__type__: typeid}
      fold (methods this) this do |this meth|:
        seq.append this (fst meth, snd meth)
      this

    {
      new: constr,
      typeid: typeid,
    }

  let istype? = do t v -> eq? t.typeid v.__type__

  {
    new: new,
    istype?: istype?,
  }